<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture â€” FeedReader Documentation</title>
    <meta name="description" content="How FeedReader is architected â€” data flow, MVC patterns, threading model, caching, and the Swift Package split.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“°</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
    <div class="nav-inner">
        <a href="index.html" class="logo">
            <img src="https://raw.githubusercontent.com/sauravbhattacharya001/FeedReader/master/FeedReader/Assets.xcassets/AppIcon.appiconset/rss180.png" alt="FeedReader">
            FeedReader
        </a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="guide.html">Guide</a></li>
            <li><a href="api.html">API Reference</a></li>
            <li><a href="architecture.html" class="active">Architecture</a></li>
            <li><a href="https://github.com/sauravbhattacharya001/FeedReader">GitHub</a></li>
        </ul>
    </div>
</nav>

<header class="page-header page-content">
    <h1>ğŸ—ï¸ Architecture</h1>
    <p>How FeedReader is structured â€” data flow, threading, caching, and the package split.</p>
</header>

<section>
    <div class="container prose">

        <h2>Project Structure</h2>
        <p>FeedReader is split into two layers: a platform-independent Swift Package and an iOS app that uses it.</p>

        <div class="arch-box">
FeedReader/
â”‚
â”œâ”€â”€ Sources/FeedReaderCore/          â† Swift Package (no UIKit)
â”‚   â”œâ”€â”€ RSSParser.swift              RSS parsing with concurrent loading
â”‚   â”œâ”€â”€ RSSStory.swift               Story model with URL/HTML safety
â”‚   â”œâ”€â”€ FeedItem.swift               Feed source model + presets
â”‚   â””â”€â”€ NetworkReachability.swift    SCNetworkReachability wrapper
â”‚
â”œâ”€â”€ FeedReader/                      â† iOS App (UIKit)
â”‚   â”œâ”€â”€ AppDelegate.swift            App lifecycle
â”‚   â”œâ”€â”€ Story.swift                  NSCoding-based story model
â”‚   â”œâ”€â”€ Feed.swift                   Feed model (app layer)
â”‚   â”œâ”€â”€ FeedManager.swift            Feed source CRUD singleton
â”‚   â”œâ”€â”€ BookmarkManager.swift        Bookmark persistence singleton
â”‚   â”œâ”€â”€ RSSFeedParser.swift          App-layer XML parser
â”‚   â”œâ”€â”€ ImageCache.swift             Async image loader + NSCache
â”‚   â”œâ”€â”€ Reachability.swift           Network detection
â”‚   â”œâ”€â”€ StoryTableViewController     Main feed list
â”‚   â”œâ”€â”€ StoryViewController          Story detail
â”‚   â”œâ”€â”€ BookmarksViewController      Saved stories
â”‚   â”œâ”€â”€ FeedListViewController       Feed manager UI
â”‚   â””â”€â”€ NoInternetFound...           Offline fallback
â”‚
â”œâ”€â”€ FeedReaderTests/                 â† App tests
â”œâ”€â”€ Tests/FeedReaderCoreTests/       â† Package tests
â””â”€â”€ Package.swift                    SPM manifest
        </div>

        <h2>Data Flow</h2>
        <p>Here's how data flows through the app from network to screen:</p>

        <div class="arch-box">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP GET      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RSS Feed    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  URLSession   â”‚
â”‚  (XML)       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  (async)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ XML data                         â”‚
       â–¼                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ XMLParser    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (per-feed    â”‚
â”‚  collector)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ [RSSStory]
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     deduplicate   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RSSParser   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Main Thread  â”‚
â”‚  (merge +    â”‚     via serial    â”‚  Delegate     â”‚
â”‚   dedup)     â”‚     queue         â”‚  Callback     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â–¼             â–¼             â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ UITableViewâ”‚ â”‚ NSCoding  â”‚ â”‚ ImageCache â”‚
                     â”‚ (display)  â”‚ â”‚ (persist) â”‚ â”‚ (thumbnailsâ”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </div>

        <h2>Threading Model</h2>
        <p>FeedReader's threading is designed for correctness without complexity:</p>

        <table class="doc-table">
            <thead><tr><th>Component</th><th>Thread</th><th>Why</th></tr></thead>
            <tbody>
                <tr><td><code>URLSession</code> tasks</td><td>Background (system)</td><td>Network I/O should never block the main thread</td></tr>
                <tr><td><code>RSSParseCollector</code></td><td>URLSession callback thread</td><td>Each feed parsed in isolation â€” no shared state</td></tr>
                <tr><td><code>RSSParser</code> merge</td><td>Serial <code>DispatchQueue</code></td><td>Protects shared <code>stories</code> and <code>seenLinks</code> from data races</td></tr>
                <tr><td>Delegate callbacks</td><td>Main thread</td><td>UI updates must happen on main thread</td></tr>
                <tr><td><code>ImageCache</code> downloads</td><td>Background (URLSession)</td><td>Image fetching doesn't block scrolling</td></tr>
                <tr><td><code>NSCoding</code> persistence</td><td>Main thread</td><td>Simple archiving â€” fast enough for typical story counts</td></tr>
            </tbody>
        </table>

        <h3>Concurrency Safety</h3>
        <p>The key concurrency challenge is multi-feed parsing. When <code>loadFeeds</code> is called with multiple URLs:</p>
        <ol>
            <li>Each URL spawns its own <code>URLSession</code> data task</li>
            <li>Each task's completion handler creates an isolated <code>RSSParseCollector</code> â€” no shared parsing state</li>
            <li>Parsed stories are merged onto a serial <code>DispatchQueue</code>, which protects the shared <code>stories</code> array and <code>seenLinks</code> set</li>
            <li>When the last feed completes, the delegate is called on the main thread</li>
            <li>If a new <code>loadFeeds</code> call arrives while a previous one is in-flight, the previous session is cancelled via <code>invalidateAndCancel()</code></li>
        </ol>

        <h2>Caching Strategy</h2>

        <h3>Story Persistence (NSCoding)</h3>
        <p>Stories are persisted to disk using <code>NSKeyedArchiver</code>/<code>NSKeyedUnarchiver</code>. This provides:</p>
        <ul>
            <li><strong>Offline reading</strong> â€” Previously fetched stories are available without network</li>
            <li><strong>Fast launch</strong> â€” Cached stories display immediately while fresh data loads</li>
            <li><strong>Graceful degradation</strong> â€” If a feed fails to load, the user still sees cached content</li>
        </ul>

        <h3>Image Caching (NSCache)</h3>
        <p>The <code>ImageCache</code> class provides a two-tier caching strategy:</p>
        <ul>
            <li><strong>In-memory (NSCache)</strong> â€” Images are cached in memory for instant access during scrolling. NSCache automatically evicts under memory pressure.</li>
            <li><strong>Async loading</strong> â€” Images are fetched on background threads. The cell checks if the image is already cached before making a network request.</li>
            <li><strong>Cell reuse safety</strong> â€” The cache key is checked against the current cell's story to prevent displaying stale images from reused cells.</li>
        </ul>

        <h2>MVC Pattern</h2>
        <p>The iOS app follows Apple's recommended MVC architecture:</p>

        <table class="doc-table">
            <thead><tr><th>Layer</th><th>Components</th><th>Responsibility</th></tr></thead>
            <tbody>
                <tr>
                    <td><strong>Model</strong></td>
                    <td><code>Story</code>, <code>Feed</code></td>
                    <td>Data representation, NSCoding conformance, equality</td>
                </tr>
                <tr>
                    <td><strong>View</strong></td>
                    <td>Storyboards, <code>StoryTableViewCell</code></td>
                    <td>Visual layout, cell rendering, image display</td>
                </tr>
                <tr>
                    <td><strong>Controller</strong></td>
                    <td><code>StoryTableViewController</code>, <code>StoryViewController</code>, etc.</td>
                    <td>User interaction, data binding, navigation, XML parsing orchestration</td>
                </tr>
            </tbody>
        </table>

        <h3>Singletons</h3>
        <p>Two singletons manage persistent state:</p>
        <ul>
            <li><strong><code>FeedManager.shared</code></strong> â€” Manages the list of RSS feed sources. Handles adding, removing, toggling, and reordering feeds. Persists to <code>UserDefaults</code> via NSCoding.</li>
            <li><strong><code>BookmarkManager.shared</code></strong> â€” Manages bookmarked stories. Persists to the app's documents directory via NSCoding.</li>
        </ul>

        <h2>The Swift Package Split</h2>
        <p>The <code>FeedReaderCore</code> Swift Package extracts platform-independent functionality:</p>

        <table class="doc-table">
            <thead><tr><th>In Package (FeedReaderCore)</th><th>In App (FeedReader)</th></tr></thead>
            <tbody>
                <tr><td><code>RSSParser</code> â€” concurrent multi-feed parsing</td><td>StoryTableViewController â€” UI + XML orchestration</td></tr>
                <tr><td><code>RSSStory</code> â€” model with URL/HTML safety</td><td><code>Story</code> â€” NSCoding model for persistence</td></tr>
                <tr><td><code>FeedItem</code> â€” feed source model + presets</td><td><code>Feed</code> â€” app-layer feed model</td></tr>
                <tr><td><code>NetworkReachability</code> â€” SCNetworkReachability</td><td><code>Reachability</code> â€” app-layer connectivity</td></tr>
            </tbody>
        </table>

        <p>The package has <strong>no UIKit dependency</strong>, making it suitable for any iOS, macOS, or server-side Swift project that needs RSS parsing.</p>

        <h2>Security Considerations</h2>

        <h3>URL Validation</h3>
        <p>All URLs (story links and image paths) are validated by <code>RSSStory.isSafeURL()</code>:</p>
        <ul>
            <li>Only <code>http</code> and <code>https</code> schemes are allowed</li>
            <li><code>javascript:</code>, <code>file:</code>, <code>data:</code>, and other schemes are rejected</li>
            <li>Stories with invalid link URLs are dropped entirely (<code>init?</code> returns <code>nil</code>)</li>
            <li>Invalid image URLs are silently discarded (imagePath set to <code>nil</code>)</li>
        </ul>

        <h3>HTML Sanitization</h3>
        <p>RSS descriptions often contain HTML. <code>RSSStory.stripHTML()</code> removes all HTML tags via regex and decodes common entities, preventing XSS-style injection in the UI.</p>

        <h3>Network Security</h3>
        <p>All feed fetching uses <code>URLSession</code> with default security settings (ATS enforced on iOS 9+). HTTPS is preferred for all preset feeds.</p>

    </div>
</section>

<footer>
    <p>Built with â¤ï¸ by <a href="https://github.com/sauravbhattacharya001">Saurav Bhattacharya</a> Â· Licensed under <a href="https://github.com/sauravbhattacharya001/FeedReader/blob/master/LICENSE">MIT</a></p>
</footer>

</body>
</html>
